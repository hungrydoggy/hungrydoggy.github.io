# 개요
이번 강의에서는 Stream과 Provider를 다루어 보겠습니다.  
플러터에서, 둘은 함께 쓰일때 빛이 납니다.  


&nbsp;  
# Stream
`Stream`은 비동기 작업을 할때 많이 사용됩니다.  
데이터가 흐르는 파이프라고 상상하시면 이해가 빠릅니다.  
데이터를 받고 싶은 곳에서 `listen`해두면, 데이터의 추가나 변경이 일어날때 받아올 수 있습니다.  

&nbsp;  
## 프로젝트 생성하기
일단 새로운 프로젝트를 하나 만들겠습니다.  
Android Studio에서, `File > New > New Flutter Project`를 선택하여,  
적당한 위치와 적당한 이름으로 새 프로젝트를 만들어 주세요.  


&nbsp;  
## 목표
프로젝트를 새로 만들고 실행하면, 우리가 익숙한 카운트업 앱이 뜨게 됩니다.  
카운트업 앱을 `Stream`을 이용하도록 하여, 버튼을 누를때 약간의 시간차를 두고 동작하도록 해보겠습니다.  

- counter값의 변화를 감지하기 위한 Stream을 만든다
- stream을 listen하여, 값이 변하면 setState를 통해 _counter값을 변경하고 화면을 갱신하도록 한다
- 버튼을 눌렀을 때, counter를 증가시켜 Stream에 전달하도록 한다


&nbsp;  
## Stream 생성
일단 `Stream`을 사용하려면, import를 해야 합니다.
```dart
import 'dart:async';
```

이제 `StreamController`를 추가해 줍니다.  
StreamController는 `dispose()` 함수를 override 하여 close 해주어야 합니다.  
```dart
    class _MyHomePageState extends State<MyHomePage> {
      int _counter = 0;
/*+*/ StreamController<int> _counter_stream_ctr;
    
/*+*/ @override
/*+*/ void initState() {
/*+*/   super.initState();
/*+*/
/*+*/   _counter_stream_ctr = StreamController<int>();
/*+*/ }

/*+*/ @override
/*+*/ void dispose() {
/*+*/   _counter_stream_ctr.close();
/*+*/
/*+*/   super.dispose();
/*+*/ }

// 이하 생략...
```

이제 Stream을 listen하여, Stream에서 오는 값으로 _counter를 바꾸고, 화면을 갱신하도록 합니다.

```dart
      @override
      void initState() {
        super.initState();
    
        _counter_stream_ctr = StreamController();
    
/*+*/   // add listener
/*+*/   final stream = _counter_stream_ctr.stream;
/*+*/   stream.listen((data) {
/*+*/     setState(() {
/*+*/       _counter = data;
/*+*/     });
/*+*/   });
      }

// 이하 생략...
```

그리고 실제 버튼을 눌렀을 때, Stream에 값을 넘기도록 수정합니다.  

```dart
      void _incrementCounter() {
/*+*/   _counter_stream_ctr.sink.add(_counter + 1);
      }

// 이하 생략...
```

`Hot Restart`를 하거나 앱을 껐다가 켠 뒤, 잘 동작하는지 확인해 봅시다.  

> Stream은 기본적으로 1:1 연결입니다.  
> 즉, 리스너를 하나만 달 수 있습니다.  
> 만일 여러 리스너를 달게 하려면, `Broadcast Stream`을 만들어야 합니다.  
> Broadcast Stream을 사용하려면, StreamController를 생성할때,  
> 기존 코드 대신 `_counter_stream_ctr = StreamController<int>.broadcast();`를 사용하면 됩니다.

&nbsp;  
## Stream Builder를 사용하도록 수정하기
이번에는 _counter 변수를 없애고, StreaBuilder를 사용해서 위젯을 구성해 보겠습니다.

다음 처럼 코드를 수정해 주세요

```dart
    class _MyHomePageState extends State<MyHomePage> {
      int _counter = 0;
      StreamController<int> _counter_stream_ctr;
    
      @override
      void initState() {
        super.initState();
    
        _counter_stream_ctr = StreamController();
    
/*-*/   // 리스너 부분 삭제
      }
    
      @override
      void dispose() {
        _counter_stream_ctr.close();
    
        super.dispose();
      }
    
      void _incrementCounter() {
/*+*/   _counter_stream_ctr.sink.add(++_counter);  // 카운터 값을 증가해서 가지고 있도록 하기
      }
    
      @override
      Widget build(BuildContext context) {
        return Scaffold(
          appBar: AppBar(
            title: Text(widget.title),
          ),
          body: Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: <Widget>[
                Text(
                  'You have pushed the button this many times:',
                ),
/*+*/           StreamBuilder<int>(
/*+*/             stream: _counter_stream_ctr.stream,
/*+*/             initialData: _counter,
/*+*/             builder: (context, snapshot) => Text(
/*+*/               '${snapshot.data}',
/*+*/               style: Theme.of(context).textTheme.display1,
/*+*/             ),
/*+*/           ),
              ],
            ),
          ),

// 이하 생략...
```

제대로 수정하셨다면, 앱이 같은 동작을 할겁니다.

StreamBuilder 코드를 자세히 보겠습니다.  
- `stream`을 통해, 사용할 stream을 등록합니다
- `initialData`를 통해, 초기값을 넣을 수 있습니다
- `builder`를 통해, builder 함수를 넘길 수 있습니다.  
파라미터 중, `snapshot.data`을 접근하면, stream으로 부터 넘어온 값을 접근할 수 있습니다.
- generic 파라미터로, int type을 넣어주는 것은, stream의 데이터가 int형임을 의미합니다.  
즉, initialData와 snapshot.data의 형이 int 입니다.

StreamBuilder 위젯으로 구성하면, stream의 값이 전달될때마다 알아서 화면을 갱신해줍니다.


&nbsp;  
# Provider
`Provider`는 위젯입니다.  
이름 처럼, generic을 통해 특정 데이터를 제공합니다.  
앞서 설명한 InheritedWidget과 유사합니다.  
Provider의 후손 위젯들은 Provider가 제공한 데이터를 접근 가능합니다.  


&nbsp;  
## 모듈 추가하기
[provider](https://pub.dev/packages/provider) 모듈을 사용하겠습니다.  
`pubspec.yaml` 파일을 열고, 아래 모듈을 추가해 주세요.  
![stream-provider-pubspec](images/stream-provider-pubspec.png)  
그리고, 에디터 상단의 `Packages get` 버튼을 눌러줍니다.  


&nbsp;
## 목표  
우리는 Provider 중, 특히 StreamProvider를 이용해보는 것이 이 강의의 목표 입니다.  
이를 이용해서, 조상 위젯 어디에선가 제공한 Stream의 값을 받아서 위젯을 구성하도록 해보겠습니다.  

아래와 같은 순서로 진행하겠습니다.  
- Provider위젯으로 고정 counter 값을 넣어준다
- CounterViewer 위젯을 하나 만든다.  
이 위젯은 위에 만든 Provider가 제공하는 값을 받아서 보여준다.
- 기존 counter를 보여주던 코드를 CounterViewer로 대체한다
- Provider 대신 StreamProvider로 대체하여, 아까 만들었던 stream을 제공한다
- CounterViewer 내부에서 StreamBuilder를 사용하도록 수정한다


&nbsp;  
## 구현
`main.dart` 파일을 열어 주세요.  
최 상단에 import를 추가 해주세요.
``` dart
      import 'package:flutter/material.dart';
/*+*/ import 'package:provider/provider.dart';

      void main() => runApp(MyApp());

      class MyApp extends StatelessWidget {
// 이하 생략...
```

일단 Provider 위젯을 추가하여, 고정 int값을 넣어줍니다.  
저는 최상단 위젯으로 추가했지만, 꼭 최상단일 필요는 없습니다.  
(제공된 값을 사용할 위젯의 조상 위젯이면 됩니다)

``` dart
      @override
      Widget build(BuildContext context) {
/*+*/   return Provider<int>.value(
/*+*/     value: 10,
/*+*/     child: Scaffold(
            appBar: AppBar(
              title: Text(widget.title),
            ),
            body: Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: <Widget>[
// 이하생략 ...
```

`CounterViewer.dart` 파일을 하나 만들어서, 동명의 클래스를 추가해 줍니다.  

```dart
```


&nbsp;  
[이번 강의 소스 코드](sources/shared-preferences.zip)  